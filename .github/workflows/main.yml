name: Build and Release JabRef Browser Extension

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Install global dependencies
        run: |
          npm install --global gulp-cli web-ext
          
      - name: Remove and clone zotero-connectors
        run: |
          rm -rf zotero-connectors
          git clone --recursive https://github.com/zotero/zotero-connectors.git
          
      - name: Install zotero-connectors dependencies
        run: |
          cd zotero-connectors
          npm install
          cd ..
          
      - name: Update canvas version in package.json
        run: |
          if [ -f package.json ]; then
            sed -i 's/"canvas":\s*"[^"]*"/"canvas": "^3.1.2"/g' package.json
          fi
          
      - name: Install dependencies
        run: npm install
        
      - name: Build extension
        run: npm run build
        
      - name: Extract and modify built extension
        run: |
          # Find the built zip file (exclude any test or node_modules directories)
          ZIPFILE=$(find . -name "*.zip" -type f -not -path "*/node_modules/*" -not -path "*/tests/*" -not -path "*/test/*" | head -n 1)
          
          if [ -n "$ZIPFILE" ]; then
            echo "Found zip file: $ZIPFILE"
            EXTRACT_PATH="build-output"
            mkdir -p "$EXTRACT_PATH"
            unzip -q "$ZIPFILE" -d "$EXTRACT_PATH"
            
            # Remove developer key from manifest.json
            MANIFEST="$EXTRACT_PATH/manifest.json"
            if [ -f "$MANIFEST" ]; then
              jq 'del(.developer)' "$MANIFEST" > "$MANIFEST.tmp" && mv "$MANIFEST.tmp" "$MANIFEST"
            fi
            
            # Modify external-scripts/zotero.js (remove lines 376-381 if-else block)
            ZOTERO_JS="$EXTRACT_PATH/external-scripts/zotero.js"
            if [ -f "$ZOTERO_JS" ]; then
              # Backup original file
              cp "$ZOTERO_JS" "$ZOTERO_JS.bak"
              
              # Remove specific if-else block around lines 376-381
              sed -i '376,381d' "$ZOTERO_JS" 2>/dev/null || true
            fi
            
            echo "EXTRACT_PATH=$EXTRACT_PATH" >> $GITHUB_ENV
          else
            echo "Error: No zip file found after build"
            exit 1
          fi
          
      - name: Clone extension-manifest-converter
        run: |
          git clone https://github.com/GoogleChromeLabs/extension-manifest-converter.git
          
      - name: Verify manifest before conversion
        run: |
          echo "=== Original Manifest ==="
          if [ -f "$EXTRACT_PATH/manifest.json" ]; then
            cat "$EXTRACT_PATH/manifest.json"
            echo ""
            echo "Manifest version: $(jq -r '.manifest_version // "not found"' "$EXTRACT_PATH/manifest.json")"
          else
            echo "ERROR: manifest.json not found!"
            exit 1
          fi
          
      - name: Convert manifest to V3
        run: |
          echo "Starting manifest conversion..."
          cd extension-manifest-converter
          python3 emc.py "../$EXTRACT_PATH" || {
            echo "Conversion failed, but continuing..."
            cd ..
            exit 0
          }
          cd ..
          
          # Check if conversion created output
          if [ -d "${EXTRACT_PATH}-mv3" ]; then
            echo "Conversion successful, replacing original..."
            rm -rf "$EXTRACT_PATH"
            mv "${EXTRACT_PATH}-mv3" "$EXTRACT_PATH"
            echo "Manifest successfully converted to V3"
          else
            echo "No -mv3 directory created. Checking for in-place conversion..."
            if [ -f "$EXTRACT_PATH/manifest.json" ]; then
              MANIFEST_VERSION=$(jq -r '.manifest_version // "2"' "$EXTRACT_PATH/manifest.json")
              if [ "$MANIFEST_VERSION" = "3" ]; then
                echo "Manifest was converted in-place to V3"
              else
                echo "WARNING: Manifest is still V2, conversion may have failed"
                echo "Continuing with original manifest..."
              fi
            fi
          fi
          
      - name: Verify final manifest
        run: |
          echo "=== Final Manifest ==="
          if [ -f "$EXTRACT_PATH/manifest.json" ]; then
            cat "$EXTRACT_PATH/manifest.json"
            echo ""
            
            # Validate JSON syntax
            if jq empty "$EXTRACT_PATH/manifest.json" 2>/dev/null; then
              echo "✓ Manifest JSON is valid"
            else
              echo "✗ ERROR: Manifest JSON is invalid!"
              exit 1
            fi
            
            # Check required fields
            NAME=$(jq -r '.name // ""' "$EXTRACT_PATH/manifest.json")
            VERSION=$(jq -r '.version // ""' "$EXTRACT_PATH/manifest.json")
            MANIFEST_V=$(jq -r '.manifest_version // ""' "$EXTRACT_PATH/manifest.json")
            
            echo "Name: $NAME"
            echo "Version: $VERSION"
            echo "Manifest Version: $MANIFEST_V"
            
            if [ -z "$NAME" ] || [ -z "$VERSION" ] || [ -z "$MANIFEST_V" ]; then
              echo "✗ ERROR: Missing required manifest fields!"
              exit 1
            fi
            
            echo "✓ All required fields present"
          else
            echo "✗ ERROR: manifest.json not found in final output!"
            exit 1
          fi
          
      - name: Create final release package
        run: |
          # Create final zip
          FINAL_ZIP="jabref-browser-extension.zip"
          cd "$EXTRACT_PATH"
          zip -r "../$FINAL_ZIP" . -q
          cd ..
          
          echo "RELEASE_FILE=$FINAL_ZIP" >> $GITHUB_ENV
          
      - name: Get version
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v$(date +%Y%m%d-%H%M%S)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          draft: false
          prerelease: false
          files: jabref-browser-extension.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jabref-browser-extension
          path: jabref-browser-extension.zip
          retention-days: 30
